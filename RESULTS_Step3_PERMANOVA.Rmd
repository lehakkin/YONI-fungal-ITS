---
title: "PERMANOVA"
author: "Laura_Hakkinen"
date: "2023-12-20"
output:
  html_document: default
  word_document: default
  pdf_document: default
---

# RESULTS STEP 3: PERMANOVA analysis at OTU level

Here I do permutational analysis of variance or PERMANOVA. With PERMANOVA, I want to check how much the main treatment factors, management type (here sample_type) and soil layer (depth), are responsible for differences in fungal communities. In addition, I will check how soil layers differ within management type (**4.5**) and in which soil layers we see a management type effect (**4.6**)

## 1. load packages and data
```{r}

library('phyloseq')
library("cowplot")
library("dplyr")
library("ggplot2")
library("vegan")
library("microbiome")
library("tibble")
library("pairwiseAdonis")


setwd('\\\\ad.helsinki.fi\\home\\l\\lehakkin\\Desktop\\PROJECT_YONI_fungal_ITS')

load('ps_FINAL')
ps

# Pick relative abundances (compositional) and sample metadata 
ps_RA <- microbiome::transform(ps, "compositional")
otu <- abundances(ps_RA)
meta <- meta(ps_RA)
```


## 2. Calculate Bray-Curtis (dis)similarities

```{r}
ps_RA_bray <- phyloseq::distance(ps_RA, method = "bray")
```


## 3. check homogenity of variances

Check that variance homogeneity assumptions hold (to ensure the reliability of the results). If  groups have signif. different spreads the permanova result may be potentially explained by that, rtaher than the groups.

Betadisper first calculates the average distance of group members to the group centroid in multivariate space (generated by a distance matrix). Then, an ANOVA is done to test if the dispersions (variances) of groups are different.

### 3.1 for management type
```{r}
anova(betadisper(ps_RA_bray, meta$sample_type))
```
         

We see that the ANOVA p-value is not significant meaning that the **homogeneity of variance assumption is met**



### 3.2 for depth
```{r}
anova(betadisper(ps_RA_bray, meta$depth))
```

We see that the ANOVA p-value is highly significant meaning that **homogeneity of variance assumption is *NOT* met**

#### 3.2.1 post hoc

I'll do post hoc analysis with Tukey's test to see which groups differ in relation to their variances

```{r}
TukeyHSD(betadisper(ps_RA_bray, meta$depth))
```

Dispersions differ significantly between 40... and all other, and between 30...40 and 10...20

The latter is not a problem at all, because I am not interested of comparing layers if they are not consecutive, **but** I will keep in mind, that the **consecutive layers 30-40 cmd and 40-80 cm do not have similar dispersions**. 


## 4. PERMANOVA

First, I will do PERMANOVA so that I include all management types (later without forest)

### 4.1 check if depth or management have larger effect

```{r}
# first with just soil type and strata option
adonis2(formula = ps_RA_bray~ sample_type, data = meta, permutations = 9999, method = "bray", by = "margin", strata = meta$depth)
```


```{r}
# then with just depth and strata option
adonis2(formula = ps_RA_bray~ depth, data = meta, permutations = 9999, method = "bray", by = "margin", strata = meta$sample_type)
```

Depth has a larger effect. So, let's put it first in the model


### 4.2 PERMANOVA full model

For the full model it matters which "by" option we choose. When by="terms" significance for each term is calculated sequentially from first to last, so that the order of terms matter. We will use this, because with sequential analysis we will get R2 values that sum up to 1, and will also get the significance and R2 values for each interaction term separately rather than for the interaction alone.


```{r}
final <- adonis2(formula = ps_RA_bray ~ depth * sample_type, data = meta, permutations = 9999, method = "bray", by = "terms")
final
```

#### 4.2.1 export the result

```{r}
write.csv2(final, "\\\\ad.helsinki.fi\\home\\l\\lehakkin\\Desktop\\PROJECT_YONI_fungal_ITS\\permanova_soiltype_and_depth.csv")
```


#### 4.2.2 PERMANOVA full model without forest

I will not use this, rather the one above with forest

```{r}
# subset samples
ps_RA <- microbiome::transform(ps, "compositional")
ps_x <- subset_samples(ps_RA, sample_type != "forest")
meta_subset <- meta(ps_x)


# You have only submitted samples, not OTUs. Define prevalence of each taxa
# (in how many samples did each taxa appear at least once)
prev0 = apply(X = otu_table(ps_x),
              MARGIN = ifelse(taxa_are_rows(ps_x), yes = 1, no = 2),
              FUN = function(x){sum(x > 0)})

# Execute prevalence filter, using `prune_taxa()` function
ps_x = prune_taxa((prev0 > 0), ps_x)
ps_x

b <- phyloseq::distance(ps_x, method = "bray")


set.seed(777)

final <- adonis2(formula = b ~ depth*sample_type, data = meta_subset, permutations = 9999, method = "bray", by = "terms")
final

```


### 4.3 Pairwise PERMANOVA: management type

Pairwise PERMANOVA I will only do so that forest is excluded due to too few replicates for forest. But I will not use these result, this is just to check

```{r}
set.seed(777)
pair.mod<-pairwise.adonis(b, factors=meta_subset$sample_type)
pair.mod
```



### 4.5 Depth effect in each management type

I will do pairwise permanova analysis of depth for all management types separately, except for forest which has too few replicates

#### 4.5.1 Meadow

```{r}
# subset samples
x <- "meadow"
ps_RA_subset <- subset_samples(ps_RA, sample_type == x)
meta_subset <- subset(meta, sample_type == x)

# You have only submitted samples, not OTUs. Define prevalence of each taxa
# (in how many samples did each taxa appear at least once)
prev0 = apply(X = otu_table(ps_RA_subset),
              MARGIN = ifelse(taxa_are_rows(ps_RA_subset), yes = 1, no = 2),
              FUN = function(x){sum(x > 0)})

# Execute prevalence filter, using `prune_taxa()` function
ps_RA_subset = prune_taxa((prev0 > 0), ps_RA_subset)
ps_RA_subset


ps_RA_subset_bray <- phyloseq::distance(ps_RA_subset, method = "bray")

set.seed(777)
pair.mod<-pairwise.adonis(ps_RA_subset_bray,factors=meta_subset$depth)
pair.mod

```


#### 4.5.2 Organic

```{r}
# subset samples
x <- "organic"
ps_RA_subset <- subset_samples(ps_RA, sample_type == x)
meta_subset <- subset(meta, sample_type == x)

# You have only submitted samples, not OTUs. Define prevalence of each taxa
# (in how many samples did each taxa appear at least once)
prev0 = apply(X = otu_table(ps_RA_subset),
              MARGIN = ifelse(taxa_are_rows(ps_RA_subset), yes = 1, no = 2),
              FUN = function(x){sum(x > 0)})

# Execute prevalence filter, using `prune_taxa()` function
ps_RA_subset = prune_taxa((prev0 > 0), ps_RA_subset)
ps_RA_subset


ps_RA_subset_bray <- phyloseq::distance(ps_RA_subset, method = "bray")

set.seed(777)
pair.mod<-pairwise.adonis(ps_RA_subset_bray,factors=meta_subset$depth)
pair.mod

```

#### 4.5.2 Conventional

```{r}
# subset samples
x <- "conventional"
ps_RA_subset <- subset_samples(ps_RA, sample_type == x)
meta_subset <- subset(meta, sample_type == x)

# You have only submitted samples, not OTUs. Define prevalence of each taxa
# (in how many samples did each taxa appear at least once)
prev0 = apply(X = otu_table(ps_RA_subset),
              MARGIN = ifelse(taxa_are_rows(ps_RA_subset), yes = 1, no = 2),
              FUN = function(x){sum(x > 0)})

# Execute prevalence filter, using `prune_taxa()` function
ps_RA_subset = prune_taxa((prev0 > 0), ps_RA_subset)
ps_RA_subset

ps_RA_subset_bray <- phyloseq::distance(ps_RA_subset, method = "bray")

set.seed(777)
pair.mod<-pairwise.adonis(ps_RA_subset_bray,factors=meta_subset$depth)
pair.mod
```


### 4.6 Management effect at different depths?


I will analyse these without forest as forest has too few replicates


#### 4.6.1 1st layer

```{r}

# define soil layer to be analysed
x <- "0...10"

# subset samples
ps_RA_subset <- subset_samples(ps_RA, sample_type != "forest")

ps_RA_subset <- subset_samples(ps_RA_subset, depth == x)
meta_subset <- subset(meta, depth == x & sample_type != "forest")

# You have only submitted samples, not OTUs. Define prevalence of each taxa
# (in how many samples did each taxa appear at least once)
prev0 = apply(X = otu_table(ps_RA_subset),
              MARGIN = ifelse(taxa_are_rows(ps_RA_subset), yes = 1, no = 2),
              FUN = function(x){sum(x > 0)})

# Execute prevalence filter, using `prune_taxa()` function
ps_RA_subset = prune_taxa((prev0 > 0), ps_RA_subset)
ps_RA_subset

ps_RA_subset_bray <- phyloseq::distance(ps_RA_subset, method = "bray")


set.seed(777)
pair.mod<-pairwise.adonis(ps_RA_subset_bray,factors=meta_subset$sample_type)
pair.mod
```


#### 4.6.2 2nd layer

```{r}

# subset samples
x <- "10...20"


# subset samples
ps_RA_subset <- subset_samples(ps_RA, sample_type != "forest")

ps_RA_subset <- subset_samples(ps_RA_subset, depth == x)
meta_subset <- subset(meta, depth == x & sample_type != "forest")

# You have only submitted samples, not OTUs. Define prevalence of each taxa
# (in how many samples did each taxa appear at least once)
prev0 = apply(X = otu_table(ps_RA_subset),
              MARGIN = ifelse(taxa_are_rows(ps_RA_subset), yes = 1, no = 2),
              FUN = function(x){sum(x > 0)})

# Execute prevalence filter, using `prune_taxa()` function
ps_RA_subset = prune_taxa((prev0 > 0), ps_RA_subset)
ps_RA_subset


ps_RA_subset_bray <- phyloseq::distance(ps_RA_subset, method = "bray")



set.seed(777)
pair.mod<-pairwise.adonis(ps_RA_subset_bray,factors=meta_subset$sample_type)
pair.mod
```


#### 4.6.3 3rd layer

```{r}

# subset samples
x <- "20...30"

# subset samples
ps_RA_subset <- subset_samples(ps_RA, sample_type != "forest")

ps_RA_subset <- subset_samples(ps_RA_subset, depth == x)
meta_subset <- subset(meta, depth == x & sample_type != "forest")

# You have only submitted samples, not OTUs. Define prevalence of each taxa
# (in how many samples did each taxa appear at least once)
prev0 = apply(X = otu_table(ps_RA_subset),
              MARGIN = ifelse(taxa_are_rows(ps_RA_subset), yes = 1, no = 2),
              FUN = function(x){sum(x > 0)})

# Execute prevalence filter, using `prune_taxa()` function
ps_RA_subset = prune_taxa((prev0 > 0), ps_RA_subset)
ps_RA_subset


ps_RA_subset_bray <- phyloseq::distance(ps_RA_subset, method = "bray")



set.seed(777)
pair.mod<-pairwise.adonis(ps_RA_subset_bray,factors=meta_subset$sample_type)
pair.mod
```


#### 4.6.4 4th layer

```{r}

# subset samples
x <- "30...40"

# subset samples
ps_RA_subset <- subset_samples(ps_RA, sample_type != "forest")

ps_RA_subset <- subset_samples(ps_RA_subset, depth == x)
meta_subset <- subset(meta, depth == x & sample_type != "forest")

# You have only submitted samples, not OTUs. Define prevalence of each taxa
# (in how many samples did each taxa appear at least once)
prev0 = apply(X = otu_table(ps_RA_subset),
              MARGIN = ifelse(taxa_are_rows(ps_RA_subset), yes = 1, no = 2),
              FUN = function(x){sum(x > 0)})

# Execute prevalence filter, using `prune_taxa()` function
ps_RA_subset = prune_taxa((prev0 > 0), ps_RA_subset)
ps_RA_subset


ps_RA_subset_bray <- phyloseq::distance(ps_RA_subset, method = "bray")



set.seed(777)
pair.mod<-pairwise.adonis(ps_RA_subset_bray,factors=meta_subset$sample_type)
pair.mod
```


#### 4.6.5 5th layer

```{r}

# subset samples
x <- "40..."

# subset samples
ps_RA_subset <- subset_samples(ps_RA, sample_type != "forest")

ps_RA_subset <- subset_samples(ps_RA_subset, depth == x)
meta_subset <- subset(meta, depth == x & sample_type != "forest")

# You have only submitted samples, not OTUs. Define prevalence of each taxa
# (in how many samples did each taxa appear at least once)
prev0 = apply(X = otu_table(ps_RA_subset),
              MARGIN = ifelse(taxa_are_rows(ps_RA_subset), yes = 1, no = 2),
              FUN = function(x){sum(x > 0)})

# Execute prevalence filter, using `prune_taxa()` function
ps_RA_subset = prune_taxa((prev0 > 0), ps_RA_subset)
ps_RA_subset


ps_RA_subset_bray <- phyloseq::distance(ps_RA_subset, method = "bray")


set.seed(777)
pair.mod<-pairwise.adonis(ps_RA_subset_bray,factors=meta_subset$sample_type)
pair.mod
```

